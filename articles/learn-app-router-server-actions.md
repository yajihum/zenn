---
title: "ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªä½œæˆã‚’é€šã—ã¦å­¦ã¶App Router/Server Actions"
emoji: "ğŸ¦¤"
type: "tech"
topics: [nextjs, approuter, Clerk, Prisma, PlanetScale]
published: true
---

## ã¯ã˜ã‚ã«

App Router ãŒå®‰å®šç‰ˆã«ãªã‚Šã€ãã‚ãã‚ã¡ã‚ƒã‚“ã¨å­¦ã°ãªã„ã¨ãªã€œã¨æ€ã£ã¦ã„ã‚‹æ–¹ã‚‚å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã¾ãŸã€Server Actions ã‚‚ã¾ã å®Ÿé¨“çš„ãªæ©Ÿèƒ½ã§ã™ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã­ï¼
ã¨ã„ã†ã“ã¨ã§ä»Šå›ã¯ã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªä½œæˆã‚’é€šã—ã¦ App Router ã¨ Server Actions ã‚’å­¦ã¹ã‚‹è¨˜äº‹ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚
ä¸€é€šã‚Šã‚„ã£ãŸå¾Œã«ã¯ App Router/Server Actions ãŒåˆ†ã‹ã£ã¦ãã¦ã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ ğŸ˜€
ã¿ãªã•ã‚“ã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ï¼

èªè¨¼ã¨ã—ã¦[Clerk](https://clerk.com/)ã€ORM ã«[Prisma](https://www.prisma.io/)ã€DB ã«[PlanetScale](https://planetscale.com/)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

:::message
PlanetScaleã®ç„¡æ–™ç‰ˆãŒå»ƒæ­¢ã•ã‚ŒãŸãŸã‚ç¾åœ¨ã¯ä»–ã®DBã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†æ–¹ãŒæœ›ã¾ã—ã„ã§ã™ï¼
Supabaseãªã©ã§ç½®ãæ›ãˆã‚‹ã‹ã€æ›¸ãç›´ã—ã¦æ¬²ã—ã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã§å¿œæ´ãã ã•ã‚Œã°ã‚‚ã†ä¸€åº¦è¨˜äº‹ã‚’æ›¸ãç›´ãã†ã¨æ€ã„ã¾ã™ğŸ™
ä¸‹è¨˜ã«ã‚ã‚‹ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆã®è¦‹ã‚Œãªããªã£ã¦ã„ã‚‹ãŸã‚æ³¨æ„ã—ã¦ãã ã•ã„
:::

ä»¥ä¸‹ãŒãƒ‡ãƒ¢ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã™ï¼
https://github.com/yajium/app-router-server-actions-study


ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆã§ã™ â†“
https://chatlife.vercel.app/

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚

1. ã„ã¤ã‚‚é€šã‚Šã‚³ãƒãƒ³ãƒ‰ã§`npx create-next-app@latest`ã‚’å®Ÿè¡Œã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚  
   ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§`App Router`ã‚’é¸æŠã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
2. `yarn dev`ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚
3. ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã®`layout.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx:layout.tsx
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body className={inter.className}>
        <main className="mx-auto flex min-h-screen max-w-5xl flex-col place-content-center justify-between md:p-12">
          {children}
        </main>
      </body>
    </html>
  );
}
```

4. ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã®`page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx:page.tsx
export default async function Home() {

  return (
    <div className="m-4">
      <p>ã“ã‚“ã«ã¡ã¯</p>
    </div>
  );
}
```

5. `global.css`ã®ä¸­èº«ã‚’ä¸€æ—¦æ¶ˆã—ã¦ç™½èƒŒæ™¯ã«çµ±ä¸€ã—ã¾ã™ã€‚  
   Tailwind CSS ã®è¨­å®šã ã‘ã«ã—ã¾ã™ã€‚

```css:global.css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

6. ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºã«ãªã£ã¦ã„ã‚Œã°ã²ã¨ã¾ãš OK ã§ã™ï¼

![ã“ã‚“ã«ã¡ã¯ã®è¡¨ç¤º](https://storage.googleapis.com/zenn-user-upload/637fa77d760a-20230601.png)

## Clerk ã‚’ä½¿ã£ãŸèªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…

æœ€è¿‘è©±é¡Œã«ãªã£ã¦ã„ãŸ[Clerk](https://clerk.com/)ã‚’ä½¿ã£ã¦èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ã‚’ã—ã¦ã„ãã¾ã™ã€‚

Clerk ã‚’ç°¡å˜ã«èª¬æ˜ã—ã¦ãŠãã¨ã€NextAuth.js ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ãªãã€ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ä½¿ã†å½¢ã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¯ GUI æ“ä½œã‚’ç”¨ã„ã¦ Clerk ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¡Œã„ã¾ã™ã€‚ä½¿ã£ã¦ã¿ãŸæ‰€æ„Ÿã¨ã—ã¦ã¯ã€èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ãŒã‚ã¡ã‚ƒãã¡ã‚ƒæ¥½ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†ã‚‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¡Œãˆã‚‹ã®ã§ã€Clerk+ä½¿ã„ãŸã„ DB ã®ã‚ˆã†ãªå½¢ã§ã€èªè¨¼ã¨ DB ã‚’åˆ†ã‘ãŸã„ã¨ãã« NextAuth.js ã®ä»£æ›¿ã¨ã—ã¦æœ‰ç”¨ã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ãƒ—ãƒ©ãƒ³ã¨ã—ã¦ã¯ã€Free ãƒ—ãƒ©ãƒ³ä»¥å¤–ã«ã‚‚ Hobbyï¼ˆ$25/æœˆï¼‰/Businessï¼ˆ$99/æœˆï¼‰ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

https://clerk.com/pricing

ä»Šå›ã¯ Free ãƒ—ãƒ©ãƒ³ã§ã‚„ã£ã¦ã„ãã¾ã™ï¼

### Clerk ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. ä»¥ä¸‹ URL ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã™ã€‚
   https://dashboard.clerk.com/
2. ã‚¢ãƒ—ãƒªã®ä½œæˆ
   ãƒ€ãƒƒã‚·ãƒ¥ãƒ¼ãƒœãƒ¼ãƒ‰ã«è¡Œã£ãŸã‚‰`Add application`ã§ã‚¢ãƒ—ãƒªã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚Application name ã«å¥½ããªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã€Sign in ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ä»Šå›ã¯ Google ã¨ GitHub ã‚’é¸æŠã—ãŸçŠ¶æ…‹ã§ Create APPLICATION ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚
3. ã‚¢ãƒ—ãƒªã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ Quickstarts ã®ã¨ã“ã‚ã§ Next.js ã‚’é¸æŠã—ã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ KEY ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
   ãã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã€å…ˆã»ã©ã‚³ãƒ”ãƒ¼ã—ãŸ KEY ãŸã¡ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚
   ã¾ãŸã€ä»¥ä¸‹ã® 3 ã¤ã®ç’°å¢ƒå¤‰æ•°ã‚‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```env:.env.local
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãš.gitignore ã«è¿½åŠ ã—ã¦ï¼ˆNext.js ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã§ OKï¼‰public ã«å¾Œæ‚”ã—ãªã„ã‚ˆã†ã«æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚ 4. ã‚¢ãƒ—ãƒªã®æº–å‚™ã¯ã§ããŸã®ã§ã€æ¬¡ã«å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰å´ã§ Clerk ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚  
 ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ clerk ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```:cmd
npm install @clerk/nextjs
```

ã²ã¨ã¾ãšã¯ã“ã‚Œã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã§ã™ï¼

### ClerkProvoder ã®ä½œæˆ

Provider ã‚’ RootLayout ã«ä½œæˆã—ã€Context ã®å…±æœ‰ã‚’è¡Œã„ã¾ã™ã€‚ã“ã® Provider ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ã©ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ã§ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ãªã©ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã§ã€RootLayout ã¨ã¯ã€ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã®æ çµ„ã¿ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹ Layout ãƒšãƒ¼ã‚¸ã§ã€ä¾‹ãˆã°`<html>`ã‚„`<body>`ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãªã©å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã«å…±é€šã™ã‚‹éƒ¨åˆ†ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›¸ã„ã¦ãŠãã“ã¨ãŒã§ãã¾ã™ã€‚

ãã—ã¦ã€åŒæ™‚ã« Clerk ã®æ—¥æœ¬èªåŒ–å¯¾å¿œã‚‚ã—ã¦ã„ãã¾ã™ã€‚

```diff tsx:layout.tsx
+ import { jaJP } from "@clerk/localizations";
+ import { ClerkProvider } from "@clerk/nextjs";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
+    <ClerkProvider localization={jaJP}>
      <html lang="ja">
        <body className={inter.className}>
          <main className="mx-auto flex min-h-screen max-w-5xl flex-col place-content-center justify-between md:p-12">
            {children}
          </main>
        </body>
      </html>
+    </ClerkProvider>
  );
}
```

`ClerkProvider`ã®éƒ¨åˆ†ã« `localization` ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§`jaJP`ã‚’æ¸¡ã—ã¦æ—¥æœ¬èªåŒ–å¯¾å¿œã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

### èªè¨¼ã•ã‚ŒãŸäººé™å®šãƒšãƒ¼ã‚¸ã®ä½œæˆ

æ¬¡ã«ã€èªè¨¼ã•ã‚ŒãŸï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ãŸï¼‰äººã®ã¿ãŒè¦‹ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹å ´åˆãªã©ã¯`middleware`ã‚’ä½¿ã£ã¦åˆ¶é™ã‚’ã‹ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
src ç›´ä¸‹ã«`middleware.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:middleware.ts
import { authMiddleware } from "@clerk/nextjs";

export default authMiddleware({
  // publicRoutesã§ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„äººã§ã‚‚è¦‹ã‚Œã‚‹ãƒšãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™
  // ä»Šå›ã®å ´åˆã¯ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã ã‘ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªãã¦ã‚‚è¦‹ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™
  publicRoutes: ["/"],
});

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

ã‚ˆã‚Šè¤‡é›‘ãªè¨­å®šã«ã—ãŸã„å ´åˆã¯ä¸‹è¨˜ã‚’å‚è€ƒã«ã—ã¦è¨­å®šã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼
https://clerk.com/docs/nextjs/middleware

### Sign in ãƒšãƒ¼ã‚¸ã®ä½œæˆ

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚
ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã® UI ã¯ Clerk ã®æ–¹ã§æ—¢ã«ç”¨æ„ã•ã‚ŒãŸã‚‚ã®ã‚’ä½¿ã†ã“ã¨ã§ç°¡å˜ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚
app ç›´ä¸‹ã«`sign-in`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ã€ãã®é…ä¸‹ã«`[[...sign-in]]`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã®`[[...sign-in]]`ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼åã®æ›¸ãæ–¹ã¯`Optional Catch-all Segments`ã¨ã„ã†ã‚‚ã®ã§`/sign-in/xxxx`ã‚„`/sign-in/yyyy/zzzz`ã ã‘ã§ãªã`/sign-in`ã«ã‚‚ãƒãƒƒãƒã—ã¦ã€ãƒšãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ãã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚
https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes#optional-catch-all-segments

`[[...sign-in]]`ãƒ•ã‚©ãƒ«ãƒ€ã¯ä»¥ä¸‹ã«`page.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:page.tsx
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return (
    <div className="flex flex-col items-center">
      <SignIn redirectUrl={"/"} />
    </div>
  );
}
```

`<SignIn />`ãŒ Clerk ã§æ—¢ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚`redirectUrl`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ä»Šå›ã®å ´åˆã¯ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã“ã§è©¦ã—ã«`/sign-in`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒå‡ºãŸã‚‰ OK ã§ã™ï¼
![Clerkã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢](https://storage.googleapis.com/zenn-user-upload/e17ce7fbd69f-20230603.png)

è©¦ã—ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«é£›ã¶ã¯ãšã§ã™ã€‚

ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã‹ã ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã¨ã—ã¦ Gogle ã‚„ GitHub ãªã©ã®å¤–éƒ¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨é€£æºã™ã‚‹ã«ã¯ãƒ—ãƒ­ãƒã‚¤ãƒ€å…ˆã«è¡Œã£ã¦åˆ¥ã®è¨­å®šãŒå¿…è¦ã«ãªã£ãŸã‚Šã™ã‚‹æ™‚ãŒã‚ã‚Šã¾ã™ãŒã€Clerk ã®å ´åˆã¯ç‰¹ã«ä½•ã‚‚ã›ãšã«åˆ©ç”¨å¯èƒ½ãªã®ã§æ¥½ã§ã„ã„ã§ã™ã­ã€‚
ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã®æ™‚ã«å‡ºã™ã‚¢ãƒ—ãƒªã®ãƒ­ã‚´ã‚„ã‚«ãƒ©ãƒ¼ãªã©ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®`Customization`ã‹ã‚‰å¤‰æ›´å¯èƒ½ã§ã™ã€‚ã¾ãŸç´°ã‹ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ Tailwind CSS ãªã©ã‚’ä½¿ã£ã¦`appearance`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰èª¿æ•´å¯èƒ½ãªã‚ˆã†ã§ã™ï¼
https://clerk.com/docs/nextjs/appearance-prop

### ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½œæˆ

ä»Šã®çŠ¶æ…‹ã ã¨ç”»é¢ãŒå¯‚ã—ã„ã®ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚
app ç›´ä¸‹ã«`_components`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®`_`ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å¯¾è±¡å¤–ã«ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦æ›¸ãæ™‚ã«ä½¿ã„ã¾ã™ã€‚ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã¯ä»¥ä¸‹å…¨ã¦ãŒãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾è±¡å¤–ã¨ãªã‚Šã¾ã™ã€‚
https://nextjs.org/docs/app/building-your-application/routing/colocation#private-folders

`_components`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®é…ä¸‹ã«`layout`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã€ãã®é…ä¸‹ã«`Header.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:_components/layout/Header.tsx
import { SignInButton, SignedIn, SignedOut, UserButton } from "@clerk/nextjs";
import Link from "next/link";

export default function Header() {
  return (
    <header className="border-b border-gray-200">
      <nav className="flex justify-between p-2">
        <div className="flex">
          <Link href={"/"} className="p-2 text-sm font-semibold md:text-2xl">
            ğŸŠChatLife
          </Link>
        </div>
        <SignedIn>
          <UserButton
            afterSignOutUrl="/"
          />
        </SignedIn>
        <SignedOut>
          <SignInButton>
            <button className="rounded bg-blue-500 px-2 text-white hover:bg-blue-400">
              ã‚µã‚¤ãƒ³ã‚¤ãƒ³
            </button>
          </SignInButton>
        </SignedOut>
      </nav>
    </header>
  );
}
```

`<SignedIn />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨`<SignedOut />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚
å‰è€…ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå¾Œè¡¨ç¤ºã•ã‚Œã‚‹ã‚‚ã®ã§ã€ä¸­ã«`<UserButtom />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸäººã®ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
å¾Œè€…ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚‚ã®ã§ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¨ã„ã†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚

ã“ã® Header ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ RootLayout ã«è¿½åŠ ã—ã¾ã™ã€‚

```diff tsx:/app/layout.tsx
...
+ import Header from "./_components/layout/header/Header";
...

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ClerkProvider localization={jaJP}>
      <html lang="ja">
        <body className={inter.className}>
+         <Header />
          <main className="mx-auto flex min-h-screen max-w-5xl flex-col place-content-center justify-between md:p-12">
            {children}
          </main>
        </body>
      </html>
    </ClerkProvider>
  );
}
```

ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºã«ãªã£ã¦ã„ã‚Œã° OK ã§ã™ï¼
![ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆå¾Œã®çŠ¶æ…‹](https://storage.googleapis.com/zenn-user-upload/8f68c389e362-20230603.png)

å·¦ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³éƒ¨åˆ†ãŒ Header.tsx ã«ã‚ã‚‹`<UserButton />`ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚‚`appearance`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã®ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¤‰ãˆã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ 

ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã¯ã‚ã‚Šã¾ã™ãŒã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ãŒãªã„çŠ¶æ…‹ã§ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã„ã‚‹ã¨æ€ã†ã®ã§ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

Clerk ã§ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã¯ [backend API ã‚’é€šã—ã¦ã®ã¿å®Ÿè¡Œå¯èƒ½](https://clerk.com/docs/users/deleting-users)ã§ã‚ã‚‹ãŸã‚ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®è¿‘ãã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†ãƒœã‚¿ãƒ³ã«é£›ã¶ã¨ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯`<UserProfile />`ã«ãªã‚Šã¾ã™ã€‚
https://clerk.com/docs/users/user-profile

ã“ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã§ãã‚Œã°ã„ã„ã®ã§ã™ãŒã€èª¿ã¹ãŸæ„Ÿã˜ã ã¨ãƒœã‚¿ãƒ³ã®è¿½åŠ ã¯ã§ããªã•ãã†ã§ã™ã€‚ï¼ˆãã‚Œç”¨ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è¨­å®šãªã©ã‚‚ãªã„ã®ã§ç„¡ç†ãã†ã§ã—ãŸï¼‰

ãã®ãŸã‚ã€ä»Šãƒ¢ãƒ¼ãƒ€ãƒ«ã¨è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‚’`/account`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§è¦‹ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã€ãã“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ã¾ãšã€app ç›´ä¸‹ã«`account`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€ãã®é…ä¸‹ã«ã„ã¤ã‚‚é€šã‚Š`page.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

page.tsx ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:page.tsx
import { UserProfile } from "@clerk/nextjs";

export default async function Account() {
  return (
    <div>
      <UserProfile />
    </div>
  );
}
```

`/account`ã«ç§»å‹•ã—ã¦ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
å…ˆã»ã©ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆç”»é¢ãŒå‡ºã¦ãã¦ã„ãŸã‚‰æˆåŠŸã§ã™ã€‚

æ¬¡ã«ã€/account ãƒšãƒ¼ã‚¸ã®ä¸‹éƒ¨ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã« back-end API ã‚’é€šã—ã¦ã§ã®ã¿ä½¿ãˆã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€Server Actions ãŒæŒã£ã¦ã“ã„ã®ãŸã‚ã€ã¾ãšã¯ Server Actions ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã€`next.config.js`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff js:next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
+ experimental: {
+   serverActions: true,
+ },
};

module.exports = nextConfig;
```

ãã—ã¦ã€`/account/page.tsx`ã«æˆ»ã‚Šã¾ã™ã€‚
ã“ã® Accout è‡ªä½“ã¯ Server Components ã§ã‚ã‚Šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã€œã®å‹•ä½œ(onClick ã®ä½¿ç”¨)ã¯ç›´æ¥ã“ã“ã«ã¯æ›¸ãã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€`<DeleteUserButton />`ã¯ Client Component ã¨ã—ã¦åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šå‡ºã—ã¾ã—ã‚‡ã†ã€‚
`/account`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ä¸‹ã«`_components`ãƒ•ã‚¡ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€ãã®é…ä¸‹ã«`DeleteUserButton.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:DeleteUserButton.tsx
"use client";

import { deleteUserAction } from "@/app/_lib/action";
import { useClerk } from "@clerk/nextjs";
import { useTransition } from "react";

export default function DeleteUserButton({ userId }: { userId: string }) {
  const [isPending, startTransition] = useTransition();
  const { signOut } = useClerk();

  return (
    <>
      {isPending ? (
        <div>loading...</div>
      ) : (
        <button
          type="button"
          onClick={() =>
            startTransition(() => {
              //deleteUserAction(userId);
              signOut();
            })
          }
          className="rounded bg-orange-400 p-3 text-white hover:bg-orange-300"
        >
          ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹
        </button>
      )}
    </>
  );
}
```

ã¾ãšã€onClick ãªã©å‰¯ä½œç”¨ãŒç™ºç”Ÿã™ã‚‹ã®ã§å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«`"use client";`ã‚’å®£è¨€ã—ã€Client Component ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
ãã—ã¦ã€button ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ããªã© form action ã§ã¯ãªã„å ´åˆã« Server Actions ã‚’ä½¿ã†ã«ã¯`startTransition`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions#custom-invocation-using-starttransition
ã“ã® startTransition ã®ä¸­ã«ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œã—ãŸã„å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚

Server Actions ã‚’ã¾ã¨ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãã“ã«`deleteUser`é–¢æ•°ã‚’æ›¸ãã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚
app ç›´ä¸‹ã«`_lib`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€ãã®é…ä¸‹ã«`action.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:/_lib/action.ts
"use server";

import { auth, clerkClient } from "@clerk/nextjs";

export async function deleteUserAction(userId: string) {
  if (!userId) return;
  await clerkClient.users.deleteUser(userId); // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
}
```

ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã§ã€ã‚µãƒ¼ãƒãƒ¼å´ã§å‡¦ç†ã™ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ã«`"use server";`ã‚’å®£è¨€ã—ã¦ã„ã¾ã™ã€‚
ãã—ã¦ã€`deleteUser`é–¢æ•°ã‚’å®£è¨€ã—ã¾ã™ã€‚ãã®éš›ã«å¿…ãš`async`ã‚’ã¤ã‘å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ã¤ã‘ãªã„ã¨ Server Actions ã¯ async ã® functions ã˜ã‚ƒãªã„ã¨ãƒ€ãƒ¡ã ã‚ˆã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
`deleteUser`ã‚’`DeleteUserButton.tsx`ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’æ¶ˆã—ã¾ã™ã€‚

ã¾ãŸã€`isPending`ã‚’ä½¿ç”¨ã—ã¦ã€Server Action ã‚’å®Ÿè¡Œä¸­ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’ãªãã—ã€ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ä¸­...ã€ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ä¸­ã ã‘ã®è¡¨ç¤ºã ã¨è¦‹ãŸç›®ãŒå¯‚ã—ã„ã®ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚
`/app/_components`é…ä¸‹ã«`ui`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€ãã®é…ä¸‹ã«`Animation.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:/app/_components/ui/Animation.tsx
export function ThreePointsAnimation() {
  return (
    <div className="flex justify-center">
      <div className="animate-ping h-2 w-2 bg-blue-600 rounded-full"></div>
      <div className="animate-ping h-2 w-2 bg-blue-600 rounded-full mx-4"></div>
      <div className="animate-ping h-2 w-2 bg-blue-600 rounded-full"></div>
    </div>
  );
}
```

ãã®å¾Œã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®éš›ã«ã“ã‚Œã‚’å‡ºã™ï¼ã¨ã„ã†ã®ã‚’æ±ºã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
App Router ã§ã¯ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã”ã¨ã«`loading.tsx`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€èª­ã¿è¾¼ã¿æ™‚ã«æ±ºã¾ã£ã¦ãã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‡ºã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šå›ã¯`app`ç›´ä¸‹ã«`loading.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãã® Loading UI ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
å…ˆã»ã©ä½œã£ãŸ`<ThreePointsAnimation />`ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:/app/loading.tsx
import { ThreePointsAnimation } from "./_components/ui/Animation";

export default function Loading() {
  return <ThreePointsAnimation />;
}
```

æ¬¡ã«ã€`/account/page.tsx`ã«æˆ»ã‚Šä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```diff tsx:/account/page.tsx
import { UserProfile, auth, clerkClient } from "@clerk/nextjs";
+ import DeleteUserButton from "./_components/DeleteUserButton";

export default async function Account() {
  const { userId } = auth();
  if (!userId) throw new Error("userId is not found");

  return (
    <div>
      <UserProfile />
+     {userId && (
+       <div className="my-16 flex flex-col items-center">
+         <DeleteUserButton userId={userId} />
+       </div>
+     )}
    </div>
  );
}
```

`auth()`ã¯ App Router ã® Server Components ã®ä¸­ã§ãªã„ã¨ä½¿ãˆãªã„é–¢æ•°ã§ã‚ã‚‹ãŸã‚ã€ã“ã“ã§ userId ã‚’å–å¾—ã—ã€`DeleteUserButton`ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã§å‹•ãã‚ˆã†ã«ãªã£ãŸã¨æ€ã†ã®ã§ã€`/account`ã«ç§»å‹•ã—ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

æœ€å¾Œã«ã€ç¾çŠ¶ã ã¨å³ä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨`/accout`ãƒšãƒ¼ã‚¸ã«é£›ã¶ã‚ˆã†ã«ãªã£ã¦ã„ãªã„ã®ã§ã€`Header.tsx`ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff tsx:/Header.tsx
...
export default function Header() {
  return (
    <header className="border-b border-gray-200">
      <nav className="flex justify-between p-2">
        ...
          <SignedIn>
            <UserButton
              afterSignOutUrl="/"
+             userProfileMode="navigation"
+             userProfileUrl="/account"
            />
          </SignedIn>
        ...
      </nav>
    </header>
  );
}
```

`userProfileMode`ã§ modal ã§ã¯ãªãã€navigation ã‚’æŒ‡å®šã—ã€ãã®ãƒŠãƒ“ã‚²ãƒ¼ãƒˆå…ˆã¨ã—ã¦`/accout`ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ã“ã‚Œã§ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨`/accout`ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## Prisma + PlanetScale ã®å°å…¥

1. PlanetScale ã®å°å…¥
   DB ã¨ã—ã¦ä»Šå›ã¯ PlanetScale ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã® DB ã‚’ä½¿ã£ã¦ã€ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚„ãƒãƒ£ãƒƒãƒˆã®ç™»éŒ²ã‚’è¡Œã„ã¾ã™ã€‚
   PlanetScalen ã®å°å…¥ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã€ã€ŒDatabase ã«æ¥ç¶šã™ã‚‹æº–å‚™ã‚’ã™ã‚‹ã€ã¾ã§çµ‚ã‚ã‚‰ã›ã¦ãã ã•ã„ã€‚

https://zenn.dev/nbr41to/articles/adabca83b2e6ea#planetscale%E3%81%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B

2. Prisma ã®å°å…¥
   ä»Šå›ã¯ ORM ã¨ã—ã¦ Prisma ã‚’ä½¿ã„ã¾ã™ã€‚
   ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€Prisma CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ ã‚’è¡Œã„ã¾ã™ã€‚

```:cmd
npm install prisma --save-dev
npm install @prisma/client
```

æ¬¡ã«ã€prisma ã®åˆæœŸåŒ–ã‚’ã—ã€schema ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã‚’è¡Œã„ã¾ã™ã€‚

```:cmd
npx prisma init
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«`/prisma/schema.prisma`ã¨`.env`ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚ŒãŸã¨æ€ã„ã¾ã™ã€‚
`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`.gitignore`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã‚„ã£ã¦ãŠãã¾ã™ã€‚

```:.gitignore
# local env files
.env
.env*.local
```

æ¬¡ã«ã€PlanetScale ã® Overview ç”»é¢ã«ã‚ã‚‹ Get Connection strings ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€`.env`ã‚¿ãƒ–ã®ä¸­èº«ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¦`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ã¾ãŸã€`schema.prisma`ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚åŒæ§˜ã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚

### Prisma ã§ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©

`schema.prisma`ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```prisma:schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url = env("DATABASE_URL")
  relationMode = "prisma"
}

model User{
  id          Int    @id @default(autoincrement())
  uuid      String @unique
  name        String
  profileImageUrl String
  chats      Chat[]
}

model Room{
  id          Int    @id @default(autoincrement())
  name        String
  description String
  chats      Chat[]
  createdAt DateTime @default(now())
}

model Chat{
  id          Int    @id @default(autoincrement())
  message     String
  room      Room @relation(fields: [roomId], references: [id])
  roomId      Int
  user      User @relation(fields: [userId], references: [id])
  userId      Int
  createdAt DateTime @default(now())

  @@index([roomId])
  @@index([userId])
}
```

Room ã¨ User ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
ã“ã‚Œã‚’ PlanetScale ã® DB ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```:cmd
npx prisma db push
```

PlanetScale ä¸Šã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚­ãƒ¼ãƒãŒç¢ºèªã§ãã‚Œã°é€£æº OK ã§ã™ï¼
![PlanetScaleã«ã‚ã‚‹ã‚¹ã‚­ãƒ¼ãƒ](https://storage.googleapis.com/zenn-user-upload/724d5df46450-20230603.png)

å®Ÿéš›ã® DB æ“ä½œã¯ Prisma Studio ã§è¡Œã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã« Prisma Studio ã‚’ç«‹ã¡ä¸Šã’ã¾ã—ã‚‡ã†ã€‚

```:cmd
npx prisma studio
```

Room ãƒ†ãƒ¼ãƒ–ãƒ«ã« 2 ã¤ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚
![Roomãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‰‹å‹•ã§è¿½åŠ ](https://storage.googleapis.com/zenn-user-upload/d770a4505ada-20230603.png)

ã“ã‚Œã§ã²ã¨ã¾ãš Prisma + PlanetScale ã®å°å…¥æº–å‚™ã¯å®Œäº†ã—ã¾ã—ãŸï¼

## ãƒ›ãƒ¼ãƒ ã®é£¾ã‚Šä»˜ã‘ã‚’ã™ã‚‹

ç¾çŠ¶ã€ãƒ›ãƒ¼ãƒ ãŒã€Œã“ã‚“ã«ã¡ã¯ã€ã®æ–‡å­—ã—ã‹ãªã„å¯‚ã—ã„çŠ¶æ…‹ã§ã‚ã‚‹ãŸã‚é£¾ã‚Šä»˜ã‘ã‚’ã—ã¦ã„ãã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®å–å¾—

Clerk ã§ä¿æŒã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‹ã‚‰åå‰ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’å–å¾—ã—ã¦è¡¨ç¤ºã•ã›ã¾ã™ã€‚

`/app/page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```tsx:/app/page.tsx
import Image from "next/image";
import Link from "next/link";
import { getUser } from "./_lib/clerk";

export default async function Home() {
  const user = await getUser();

  return (
    <div className="m-4">
      <div>
        <p className="mt-4 text-2xl font-semibold">
          ã“ã‚“ã«ã¡ã¯ï¼{" "}
          {user ? (
            <Link
              href="/account"
              className="text-orange-400 hover:border-b-2 hover:border-b-orange-400 "
            >
              {user?.username}
            </Link>
          ) : (
            <span className="text-orange-400">ã‚²ã‚¹ãƒˆ</span>
          )}
          ã•ã‚“
        </p>
      </div>
      {!user && (
        <div className="my-6">
          <Link
            href="/sign-in"
            className="rounded bg-blue-500 p-3 text-white hover:bg-blue-400"
          >
            ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </Link>
        </div>
      )}
      {user && user.profileImageUrl && (
        <Image
          src={user.profileImageUrl}
          width={100}
          height={100}
          alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ"
          className="my-4"
        />
      )}
    </div>
  );
}
```

`/app/_lib`é…ä¸‹ã«`clerk.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã€ãã“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°`getUser`ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```ts:/_lib/clerk.ts
import { auth, clerkClient } from "@clerk/nextjs";

export const getUser = async () => {
  const { userId } = auth();
  const user = userId ? await clerkClient.users.getUser(userId) : null;
  return user;
};
```

ã“ã®é–¢æ•°ã‚’ä½¿ã†ã®ã¯ Server Componets ã§ã‚ã‚‹ãŸã‚ã€back-end API ã‚’é€šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚

ã¾ãŸã€`<Link />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® src ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¤–éƒ¨ URLï¼ˆä»Šå›ã®å ´åˆã ã¨ Google ã‚„ GitHub ã‹ã‚‰å–å¾—ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€`next.config.js`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```js:next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "images.clerk.dev",
        port: "",
      },
      {
        protocol: "https",
        hostname: "www.gravatar.com",
        port: "",
      },
    ],
  },
  experimental: {
    serverActions: true,
  },
};

module.exports = nextConfig;
```

ã“ã‚Œã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒå‡ºã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼
![åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤º](https://storage.googleapis.com/zenn-user-upload/71c9642e3318-20230603.png)

### ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®è¡¨ç¤º

ã¾ã ãƒ›ãƒ¼ãƒ ãŒå¯‚ã—ã„ã®ã§ã€ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸‹ã«ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤ºã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

`app/page.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff tsx:/app/page.tsx
import Image from "next/image";
import Link from "next/link";
import { getUser } from "./_lib/clerk";
+ import Loading from "./loading";
+ import { Suspense } from "react";
+ import Rooms from "./_components/Rooms";

export default async function Home() {
  const user = await getUser();

  return (
    <div className="m-4">
      <div>
        <p className="mt-4 text-2xl font-semibold">
          ã“ã‚“ã«ã¡ã¯ï¼{" "}
          {user ? (
            <Link
              href="/account"
              className="text-orange-400 hover:border-b-2 hover:border-b-orange-400 "
            >
              {user?.username}
            </Link>
          ) : (
            <span className="text-orange-400">ã‚²ã‚¹ãƒˆ</span>
          )}
          ã•ã‚“
        </p>
      </div>
      {!user && (
        <div className="my-6">
          <Link
            href="/sign-in"
            className="rounded bg-blue-500 p-3 text-white hover:bg-blue-400"
          >
            ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </Link>
        </div>
      )}
      {user && user.profileImageUrl && (
        <Image
          src={user.profileImageUrl}
          width={100}
          height={100}
          alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ"
          className="my-4"
        />
      )}
+     <div className="my-20">
+       <Suspense fallback={<Loading />}>
+         <a id="rooms" className="mx-2 text-gray-600">
+           å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ä¸€è¦§
+         </a>
+         <Rooms />
+       </Suspense>
+     </div>
+   </div>
  );
}
```

`<Rooms />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ã‚‚ã®ã§ã€DB ã‹ã‚‰éåŒæœŸã«å–å¾—ã—ã¦ Suspense ã§å›²ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚èª­ã¿è¾¼ã‚“ã§ã„ã‚‹é–“ã¯`<Loading />`ã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`<Rooms />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
ã¾ãšã€`/app/_components`é…ä¸‹ã«`Rooms.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ãã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:Rooms.tsx
import { prisma } from "../_lib/prisma";
import Link from "next/link";
import ChatsNum from "./ChatsNum";
import { JumpIcon } from "./ui/Icon";

export default async function Rooms() {
  const rooms = await prisma.room.findMany(); //Roomãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å…¨ã¦ã®ãƒ«ãƒ¼ãƒ ã‚’å–å¾—
  if (!rooms || rooms.length === 0)
    return <div className="my-14">sorry... å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ğŸ¥¹</div>;

  return (
    <div className="my-8 grid gap-4 md:grid-cols-3">
      {rooms.map((room) => (
        <Link
          href={`/room/${room.id}`}
          className="flex h-full flex-col justify-between rounded-3xl border p-5 text-left shadow hover:bg-gray-100"
          key={room.id}
        >
          <div className="my-4 flex">
            <p className="mr-2 text-sm font-semibold text-blue-500 md:text-base">
              {room.name}
            </p>
            <JumpIcon />
          </div>
          <p className="text-sm text-gray-500">{room.description}</p>
          <ChatsNum id={room.id} />
        </Link>
      ))}
    </div>
  );
}
```

`<JumpIcon />`ã¨`<ChatsNum />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆ¥ã§ä½œæˆã—ã¾ã™ã€‚

`<JumpIcon />`ã¯ã€`/app/_components/ui`é…ä¸‹ã«`Icon.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```tsx:Icon.tsx
export const JumpIcon = () => {
  return (
    <svg
      className="h-6 w-6 text-gray-300"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <line x1="7" y1="17" x2="17" y2="7" />{" "}
      <polyline points="7 7 17 7 17 17" />
    </svg>
  );
};

export const ChatIcon = () => {
  return (
    <svg
      className="h-5 w-5 text-orange-400"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      strokeWidth="2"
      stroke="currentColor"
      fill="none"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      {" "}
      <path stroke="none" d="M0 0h24v24H0z" />{" "}
      <rect x="3" y="5" width="18" height="14" rx="2" />{" "}
      <polyline points="3 7 12 13 21 7" />
    </svg>
  );
};

export const ArrowBottomIcon = () => {
  return (
    <svg
      className="h-8 w-8 text-blue-500"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        strokeWidth="2"
        d="M19 14l-7 7m0 0l-7-7m7 7V3"
      />
    </svg>
  );
};
```

ã‚ã¨ã§ä½¿ã† Icon ã‚‚è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

`<ChatsNum />`ã¯ã€`/app/_components`é…ä¸‹ã«`ChatsNum.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãã“ã«ä¸­èº«ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

ã“ã‚Œã¯å„ãƒ«ãƒ¼ãƒ ãŒæŒã£ã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆæ•°ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

```tsx:ChatsNum.tsx
import { getChatsNumByRoomId } from "../_lib/prisma";
import { ChatIcon } from "./ui/Icon";

export default function ChatsNum({ id }: { id: number }) {
  const num = getChatsNumByRoomId(id);
  return (
    <div className="my-4 flex w-1/5 rounded-full border border-orange-400 px-3 py-2 text-orange-400 md:w-1/3 lg:w-1/4">
      <p className="mx-auto block text-left text-sm font-semibold">{num}</p>
      <ChatIcon />
    </div>
  );
}
```

ãƒ«ãƒ¼ãƒ  ID ã‹ã‚‰ãã®ãƒ«ãƒ¼ãƒ ãŒæŒã£ã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆæ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°`getChatsNumByRoomId`ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã«ã€`/_lib/prisma.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:prisma.ts
import { PrismaClient } from "@prisma/client";
export const prisma = new PrismaClient();

export const getChatsNumByRoomId = (id: number) => {
  const count = prisma.chat.count({
    where: {
      roomId: id,
    },
  });
  return count;
};
```

ã“ã‚Œã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼
![ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®è¡¨ç¤º](https://storage.googleapis.com/zenn-user-upload/28a3a52052c4-20230603.png)

## å„ãƒ«ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ä½œæˆ

`Rooms`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å„ãƒ«ãƒ¼ãƒ ã¸ã®ãƒªãƒ³ã‚¯ã«`href={`/room/${room.id}`}`ã¨æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒªãƒ³ã‚¯å…ˆã¨ãªã‚‹ãƒšãƒ¼ã‚¸ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

`app`ç›´ä¸‹ã«`/room/[id]`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã€ãã®é…ä¸‹ã«`page.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx:/room/[id]/page.tsx
import { getUser } from "@/app/_lib/clerk";
import Loading from "@/app/loading";
import { formatDate, getChats, getRoomById } from "@/app/_lib/prisma";
import { auth } from "@clerk/nextjs";
import { redirect } from "next/navigation";
import { Suspense } from "react";
import Chats from "./_components/Chats";
import Form from "./_components/Form";

export default async function Room({ params }: { params: { id: string } }) {
  const room = await getRoomById(parseInt(params.id));
  if (!room) {
    return <div>ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>;
  }

  const createdDate = room.createdAt ? formatDate(room.createdAt) : undefined;

  const user = await getUser();
  if (!user) {
    redirect("/sign-in");
  }
  const userName =
    user.username && user.username !== "" ? user.username : "ã‚²ã‚¹ãƒˆ";

  const chats = await getChats(parseInt(params.id));

  return (
    <div className="mx-4 text-center">
      <div className="border-b border-b-gray-300 py-4 text-left">
        <h2 className="my-2 text-base md:text-2xl">{room.name}</h2>
        <div className="flex justify-between text-gray-500">
          <p className="text-xs md:text-sm">{room.description}</p>
          {createdDate && <p>ä½œæˆæ—¥ : {createdDate}</p>}
        </div>
      </div>
      <div className="my-6 md:my-8">
        <Suspense fallback={<Loading />}>
          {/* @ts-expect-error Async Server Component */}
          <Chats chats={chats} />
          <Form
          roomId={parseInt(params.id)}
          uuid={user.id}
          username={userName}
          profileImageUrl={user.profileImageUrl}
        />
        </Suspense>
      </div>
    </div>
  );
}
```

`params`ã§ URL ã‹ã‚‰å–å¾—ã—ãŸ id ãŒå…¥ã£ãŸçŠ¶æ…‹ã§ãƒ«ãƒ¼ãƒ  ID ã‚’å–å¾—ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`/room/1`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã€ã“ã®`id="1"`ãŒå–å¾—ã§ãã¦ã„ã¾ã™ã€‚
ã¾ãŸã€`<Form />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã—ã¦ã„ã‚‹å¼•æ•°ã¨ã—ã¦`uuid`ã‚„`username`ã€`profileImageUrl`ãŒã‚ã‚Šã¾ã™ãŒã€ãªãœ`User`å‹ã® user ã‚’ãã®ã¾ã¾æ¸¡ã•ãšã«åˆ†ã‘ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€ã€€ Server Component ã‹ã‚‰ Client Componentï¼ˆä»Šå›ã®å ´åˆã¯ Formï¼‰ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¸¡ã™ã¨ãã¯ã€JSON å½¢å¼ã«ãƒ‘ãƒ¼ã‚¹ã§ãã‚‹æ–‡å­—åˆ—ã§ãªã„ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« warning ãŒç™ºç”Ÿã™ã‚‹ã‹ã‚‰ã§ã™ã€‚user ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã—ãŸã„ã¨ãã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã£ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã—ã‹ãªã•ãã†ã§ã™ã€‚
https://zenn.dev/sev3e3e/articles/43f566d940c807

ã“ã® id ã‚’ä½¿ã£ã¦ã€ãƒ«ãƒ¼ãƒ ã‚’å–å¾—ã™ã‚‹é–¢æ•°`getRoomById`ã¨ãƒ«ãƒ¼ãƒ ä½œæˆæ—¥ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°`formatDate`ã€ãƒãƒ£ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°`getChats`ã€User ãƒ†ãƒ¼ãƒ–ãƒ«ã® id ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°`getUserById`ã‚’`/_lib/prisma.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ã€‚

```ts:prisma.ts
...

export const getRoomById = (id: number) => {
  const room = prisma.room.findUnique({
    where: { id: id },
    select: {
      name: true,
      description: true,
      createdAt: true,
      chats: true,
    },
  });
  return room;
};

export const getChats = (roomId: number) => {
  const chats = prisma.chat.findMany({
    where: {
      roomId: roomId,
    },
    orderBy: {
      createdAt: "asc",
    },
  });
  return chats;
};

export const formatDate = (date: Date) => {
  const [year, month, day] = [
    date.getFullYear(),
    date.getMonth() + 1,
    date.getDate(),
  ];
  return `${year}/${month}/${day}`;
};

export function getUserById(id: number) {
  const user = prisma.user.findUnique({
    where: { id: id },
    select: {
      uuid: true,
      name: true,
      profileImageUrl: true,
    },
  });
  return user;
}
```

`<Chats />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨`<Form />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
`[id]`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼é…ä¸‹ã«`_components`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ã€ãã®é…ä¸‹ã«`Chats.tsx`ã¨`Form.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

`Chats.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:Chats.tsx
import { ArrowBottomIcon } from "@/app/_components/ui/Icon";
import { getUserById } from "@/app/_lib/prisma";
import { auth } from "@clerk/nextjs";
import { Chat } from "@prisma/client";
import Image from "next/image";

export default async function Chats({ chats }: { chats: Chat[] }) {
  if (!chats || chats.length === 0)
    return (
      <div className="flex flex-col items-center justify-center gap-3">
        <p>ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ğŸ¥º</p>
        <p>ã¿ã‚“ãªã«è©±ã—ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
        <ArrowBottomIcon />
      </div>
    );

  const chatList = await Promise.all(
    chats.map(async (chat) => {
      // Prismaã§Chatãƒ†ãƒ¼ãƒ–ãƒ«ã®userIdã‹ã‚‰Userãƒ†ãƒ¼ãƒ–ãƒ«ã®userã‚’å–å¾—ã™ã‚‹
      const user = await getUserById(chat.userId);
      return {
        id: chat.id,
        name: user?.name,
        profileImageUrl: user?.profileImageUrl,
        message: chat.message,
        isMe: user?.uuid === auth().userId,
      };
    })
  );

  return (
    <div className="h-96 overflow-auto text-left">
      {chatList.map((chat) => {
        return (
          <div
            key={chat.id}
            className={`flex items-start p-2 md:p-3 ${
              chat.isMe ? "flex-row-reverse" : ""
            }`}
          >
            <div className="flex flex-col items-center">
              {chat.profileImageUrl ? (
                <Image
                  src={chat.profileImageUrl}
                  width={30}
                  height={30}
                  alt={chat.name ?? ""}
                  className="h-8 w-8 md:w-12 md:h-12"
                />
              ) : (
                <div>ğŸ˜ƒ</div>
              )}
              <p className="text-center text-xs text-gray-500 md:text-sm">
                {chat.name ?? "ã‚²ã‚¹ãƒˆ"}
              </p>
            </div>
            <p className="mx-1 justify-self-stretch p-4 text-xs md:mx-4 md:text-sm">
              {chat.message}
            </p>
          </div>
        );
      })}
    </div>
  );
}
```

`Form.tsx`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:Form.tsx
"use client";

import { createChatAction, upsertUserAction } from "@/app/_lib/action";

import { useRef, useState } from "react";

export default function Form({
  roomId,
  uuid,
  username,
  profileImageUrl,
}: {
  roomId: number;
  uuid: string;
  username: string;
  profileImageUrl: string;
}) {
  const [ispending, setIspending] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const formRef = useRef<HTMLFormElement>(null);

  async function handleSubmit(formData: FormData) {
    setIspending(true); // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’éæ´»æ€§ã«ã™ã‚‹
    setError(null);

    const message = formData.get("message");

    if (!message || typeof message !== "string") {
      setError("1æ–‡å­—ä»¥ä¸Šã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      setIspending(false);
      return;
    }

    // Server Actionã®å®Ÿè¡Œ
    // Prismaã®Userãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã¾ãŸã¯ä½œæˆã™ã‚‹
    const userData = await upsertUserAction(uuid, username, profileImageUrl);
    await createChatAction(roomId, userData.id, message);

    setIspending(false);
    formRef.current?.reset();
  }

  if (ispending) {
    return <Loading />;
  }

  return (
    <div className="my-10 bg-white">
      <form
        className="flex items-center border-t border-gray-200 p-4"
        action={handleSubmit}
        ref={formRef}
      >
        {error && (
          <div>
            <p className="text-red-500">{error}</p>
          </div>
        )}
        <input
          type="text"
          name="message"
          autoComplete="off"
          className="flex-grow rounded-lg border px-4 py-2 focus:border-blue-300 focus:outline-none focus:ring"
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
        />
        <button
          type="submit"
          disabled={ispending}
          className="rounded-lg bg-blue-500 hover:bg-blue-400 px-2 md:px-4 py-2 text-white text-xs md:text-sm focus:border-blue-300 focus:outline-none focus:ring w-1/6"
        >
          é€ä¿¡
        </button>
      </form>
    </div>
  );
}
```

`"use client";`ã§ Client Component ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚
ã‚µãƒ¼ãƒãƒ¼å´ã§å–å¾—ã—ãŸ roomId ã¨ userï¼ˆClerk ã‹ã‚‰ã®å–å¾—ï¼‰ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã¡ã‚ƒã‚“ã¨ã‚„ã‚‹ãªã‚‰ Zod ãªã©ã‚’ä½¿ã£ã¦ã‚„ã£ãŸã»ã†ãŒã„ã„ã‹ã‚‚ã§ã™ã€‚

form action ã§ handleSubmit é–¢æ•°ã‚’æŒ‡å®šã—ã¦ãŠã‚Šã€ãã®ä¸­ã§ãƒœã‚¿ãƒ³ã®éæ´»æ€§ã‚„ã‚¨ãƒ©ãƒ¼ã®åˆ¶å¾¡ã€Server Action é–¢æ•°ã®å®Ÿè¡Œã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
`upsertUserAction`ã¨`createChatAction`é–¢æ•°ã‚’`action.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```diff ts:action.ts
...
+import { revalidatePath } from "next/cache";
+import { createChat, createUser } from "./prisma";

...

+export async function upsertUserAction(
+  uuid: string,
+  name: string,
+  profileImageUrl: string
+) {
+  return await createUser(uuid, name, profileImageUrl);
+}

+export const createChatAction = async (
+  roomId: number,
+  userId: number,
+  message: string
+) => {
+  await createChat(roomId, userId, message);
+};
```

`prisma.ts`ã«ã€`action.ts`ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ createUser`ã¨`createChat`é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts:prisma.ts
export function createUser(
  uuid: string,
  name: string,
  profileImageUrl: string
) {
  const user = prisma.user.upsert({
    where: { uuid: uuid },
    update: {
      name: name,
      profileImageUrl: profileImageUrl,
    },
    create: {
      uuid: uuid,
      name: name,
      profileImageUrl: profileImageUrl,
    },
  });
  return user;
}

export function createChat(roomId: number, userId: number, message: string) {
  const chat = prisma.chat.create({
    data: {
      roomId: roomId,
      userId: userId,
      message: message,
    },
  });
  return chat;
}
```

`prisma.user.upsert`éƒ¨åˆ†ã® upsert ã¯`update`ã¨`insert`ã®ä¸¡æ–¹ã‹ã‚‰å–ã£ãŸã‚‚ã®ã§ã€User ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã¯æ›´æ–°ã‚’ã€å­˜åœ¨ã—ã¦ã„ãªã„å ´åˆã¯æ–°è¦ä½œæˆã‚’è¡Œãªã£ã¦ãã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚

ãƒ›ãƒ¼ãƒ ã«ã‚ã‚‹ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‹ã‚‰é©å½“ãªãƒ«ãƒ¼ãƒ ã«é£›ã‚“ã§ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºã«ãªã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
![å„ãƒ«ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®è¡¨ç¤º](https://storage.googleapis.com/zenn-user-upload/09d3fe6411f5-20230603.png)

ã“ã®çŠ¶æ…‹ã§ãƒãƒ£ãƒƒãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã‚‹ã¨ã€ä½•ã‚‚è¡¨ç¤ºãŒå¤‰ã‚ã‚‰ãªã„ã®ã§ã©ã“ã‹ãŒãŠã‹ã—ã„ã§ã™ã€‚
ã“ã®ç†ç”±ã¯ã€Server Actions ã§ã‚µãƒ¼ãƒãƒ¼å´ã®å‡¦ç†ã‚’è¡Œã£ãŸæ™‚ã«ã€å†æ¤œè¨¼ãŒã•ã‚Œã¦ãŠã‚‰ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã£ãŸçŠ¶æ…‹ã«ãªã£ã¦ãŠã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¡¨ç¤ºãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹ã‚‰ã§ã™ã€‚

ãã®ãŸã‚ã€å†æ¤œè¨¼(revalidate)ã‚’è¡Œã†ãŸã‚ã«ã€`revalidatePath`é–¢æ•°ã‚’ action.ts ã®`createChatAction`é–¢æ•°ã®æœ€å¾Œã«è¿½è¨˜ã—ã¾ã™ã€‚

```diff ts:action.ts
+import { revalidatePath } from "next/cache";
...
export const createChatAction = async (
  roomId: number,
  userId: number,
  message: string
) => {
  await createChat(roomId, userId, message);
+  revalidatePath(`/room/${roomId}`);
};
```

`revalidatePath`ã¯ä»¥ä¸‹ã§è©³ã—ã„èª¬æ˜ãŒè¦‹ã‚Œã¾ã™ã€‚
https://nextjs.org/docs/app/api-reference/functions/revalidatePath

ã“ã‚Œã§ã€å†åº¦ãƒãƒ£ãƒƒãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã‚‹ã¨å†æ¤œè¨¼ãŒè¡Œã‚ã‚Œã¦ãƒãƒ£ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚
![ãƒãƒ£ãƒƒãƒˆé€ä¿¡å¾Œã®è¡¨ç¤º](https://storage.googleapis.com/zenn-user-upload/0db4ee6dbe69-20230603.png)

## ãƒ«ãƒ¼ãƒ ä½œæˆãƒšãƒ¼ã‚¸ã®ä½œæˆ

ã„ã‚ˆã„ã‚ˆç–²ã‚Œã¦ãã¡ã‚ƒã£ãŸã®ã§ã™ãŒã€ã‚ã¨ä¸€æ¯ã§çµ‚ã‚ã‚Šã¾ã™ã€‚
æ¬¡ã¯ãƒ«ãƒ¼ãƒ ä½œæˆã®ãƒšãƒ¼ã‚¸ã‚’ä½œã‚Šã¾ã™ã€‚

`/app/room`é…ä¸‹ã«`create`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ã€ãã®é…ä¸‹ã«`page.tsx`ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx:page.tsx
"use client";

import { createRoomAction } from "@/app/_components/action";
import { redirect } from "next/navigation";
import { useState } from "react";

export default function Create() {
  const [ispending, setIspending] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ğŸ¤¨isPendingãŒtrueã®æ™‚ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°UIã‚’å‡ºãã†ã¨ã™ã‚‹ã¨redirectã—ãªããªã£ã¦ã—ã¾ã†
  async function handleSubmit(formData: FormData) {
    setIspending(true);
    setError(null);

    const [name, description] = [
      formData.get("name"),
      formData.get("description"),
    ];

    if (
      !name ||
      typeof name !== "string" ||
      !description ||
      typeof description !== "string"
    ) {
      setError("1æ–‡å­—ä»¥ä¸Šã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      setIspending(false);
      return;
    }

    const room = await createRoomAction(name as string, description as string);
    setIspending(false);
    redirect(`/room/${room.id}`);
  }

  return (
    <div className="mx-4 my-10 flex flex-col-reverse bg-white md:flex-row">
      <form className="flex basis-1/2 flex-col gap-10" action={handleSubmit}>
        {error && (
          <div>
            <p className="text-red-500">{error}</p>
          </div>
        )}
        <div>
          <label htmlFor="name">
            ğŸŠãƒ«ãƒ¼ãƒ ã®åå‰<span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            autoComplete="off"
            className="w-full rounded-lg border px-4 py-2 my-3 focus:border-blue-300 focus:outline-none focus:ring"
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          />
        </div>
        <div>
          <label htmlFor="description">
            ğŸŠã©ã‚“ãªãƒ«ãƒ¼ãƒ ã§ã™ã‹ï¼Ÿ<span className="text-red-500">*</span>
          </label>
          <textarea
            id="description"
            name="description"
            autoComplete="off"
            className="h-40 w-full rounded-lg border px-4 py-2 my-3 focus:border-blue-300 focus:outline-none focus:ring"
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          />
        </div>
        <button
          type="submit"
          disabled={ispending}
          className="rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-400"
        >
          ãƒ«ãƒ¼ãƒ ã‚’ã¤ãã‚‹
        </button>
      </form>
    </div>
  );
}

```

:::message
isPending ã§ãƒ«ãƒ¼ãƒ ä½œæˆä¸­ã®ã¨ãã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° UI ã‚’å‡ºã™ã‚ˆã†ã«ã—ãŸã„ã®ã§ã™ãŒã€`if(isPending)`ã® return ã§<Loading />ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã¨ redirect ã®å‡¦ç†ã«è¡Œã‹ãªããªã£ã¦ã—ã¾ã†ãªã©ã§ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã§ã™ ğŸ¤”
`useFormStatus`ã¨ã„ã†ã®ãŒå®Ÿé¨“çš„æ©Ÿèƒ½ã§ä½¿ãˆã‚‹ã‚ˆã†ãªã®ã§ã™ãŒã€ã“ã‚Œã‚‚ä¸Šæ‰‹ãæ©Ÿèƒ½ã—ã¦ã„ãªã„ã¿ãŸã„ã§ä½¿ãˆãªã‹ã£ãŸã®ã§ã€ä½•ã‹ã„ã„æ–¹æ³•ãŒã‚ã‚Œã°æ•™ãˆã¦ã„ãŸã ããŸã„ã§ã™ï¼
https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions#experimental-useformstatus
:::

å…ˆã»ã©ã®ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã¨åŒã˜å®¹é‡ã§ form ã«å¯¾ã—ã¦ Server Action ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
`createRoomAction`é–¢æ•°ã‚’`action.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¾ã™ã€‚

```ts:action.ts
export const createRoomAction = async (name: string, description: string) => {
  const room = await createRooms(name, description);
  return room;
};
```

ãã—ã¦ã€`createRooms`é–¢æ•°ã‚’`prisma.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¾ã™ã€‚

```ts:
export const createRooms = (name: string, description: string) => {
  const prisma = new PrismaClient();
  const room = prisma.room.create({
    data: {
      name: name,
      description: description,
    },
  });
  return room;
};
```

ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã®å³å´ãŒå¯‚ã—ã„ã®ã§ä½•ã‹ç”»åƒãªã©ã‚’è¿½åŠ ã—ã¦ã‚‚ã„ã„ã‹ã‚‚ã§ã™ï¼

`/room/create`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ã‚‹ã¨ã€ä½œæˆå¾Œã€ä½œã£ãŸãƒ«ãƒ¼ãƒ ã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãŸã‚‰ OK ã§ã™ã€‚

## ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ”¹ä¿®

`/room/create`ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒªãƒ³ã‚¯ãŒã¾ã ãªã„ã®ã§ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä½œæˆã—ã¾ã™ã€‚

`/app/_components/layout`é…ä¸‹ã«`header`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆã—ã€ãã“ã«`Header.tsx`ã‚’ç§»å‹•ã™ã‚‹ã®ã¨åŒæ™‚ã«ã€`LinkList.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx:LinkList.tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";

const linkList = [
  {
    href: "/room/create",
    text: "ãƒ«ãƒ¼ãƒ ã‚’ã¤ãã‚‹",
  },
];

export default function LinkList() {
  const pathname = usePathname();
  return (
    <>
      {linkList.map((link, index) => {
        const isActive = pathname.startsWith(link.href);
        return (
          <Link
            key={index}
            href={link.href}
            className={`mx-1 rounded-2xl px-2 py-1.5 text-sm md:my-2 md:px-4 ${
              isActive
                ? "bg-orange-200 text-orange-600"
                : "text-gray-500 hover:bg-orange-200 hover:text-orange-600"
            }`}
          >
            {link.text}
          </Link>
        );
      })}
    </>
  );
}
```

`usePathname`é–¢æ•°ã¯ç¾åœ¨ã® URL ãƒ‘ã‚¹ã‚’å–å¾—ã—ã€ãã®ãƒ‘ã‚¹ãŒ linkList
ã§è¨­å®šã—ã¦ã„ã‚‹ href ã¨åŒã˜ã‹ã©ã†ã‹ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¤‰ãˆã¦ã„ã¾ã™ã€‚
https://nextjs.org/docs/app/api-reference/functions/use-pathname

ã“ã®`<LinkList />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’`Header.tsx`ã«è¿½åŠ ã—ã¾ã™ã€‚

```diff tsx:Header.tsx
...
+import LinkList from "./LinkList";

export default function Header() {
  return (
    <header className="border-b border-gray-200">
      <nav className="flex justify-between p-2">
        <div className="flex">
          <Link href={"/"} className="p-2 text-sm font-semibold md:text-2xl">
            ğŸŠChatLife
          </Link>
+         <LinkList />
        </div>
        ...
      </nav>
    </header>
  );
}
```

`Header.tsx`ã®ãƒ‘ã‚¹ãŒå¤‰ã‚ã£ãŸã®ã§`/app/layout.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã® Header.tsx ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚‚ä¿®æ­£ã—ã¾ã™ã€‚

ã“ã‚Œã§ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ«ãƒ¼ãƒ ã‚’ã¤ãã‚‹ãƒœã‚¿ãƒ³ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚
![ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ã‚‹ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã®è¡¨ç¤º](https://storage.googleapis.com/zenn-user-upload/0d5271d19163-20230603.png)

## ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

ã„ã‚ˆã„ã‚ˆæœ€å¾Œã§ã™ï¼ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

ã¾ãšã€PlanetScale ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¡Œãã€main ãƒ–ãƒ©ãƒ³ãƒç”»é¢ã§`Promote to production`ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

æ¬¡ã«ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ç™ºç”Ÿã™ã‚‹ Prisma ã®ã‚¨ãƒ©ãƒ¼è§£æ¶ˆã®ãŸã‚ã€`package.json`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```diff json:package.json
"scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
+   "postinstall": "prisma generate"
  },
```

ãã—ã¦ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ GitHub ç­‰ã§ push ã—ã¾ã—ã‚‡ã†ã€‚

æ¬¡ã« Vercel ã§æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€`Environment Variables`ã«`.env`ã¨`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã—ãŸ Key ã¨ Value ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã‚ã¨ã¯ãƒ“ãƒ«ãƒ‰ã—ã¦æœ€å¾Œã¾ã§é€šã—ãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã§ã™ï¼

## çµ‚ã‚ã‚Šã«

ã“ã‚Œã§ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã¯ä¸€é€šã‚Šæ©Ÿèƒ½ã™ã‚‹ã¨ã“ã‚ã¾ã§ã„ã‘ãŸã¨æ€ã„ã¾ã™ã€‚
ãƒãƒ£ãƒƒãƒˆã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã—ã¦ã„ãªã„ã®ã§ã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã¨ã„ã†ã‚ˆã‚Šã‹ã¯æ²ç¤ºæ¿ã«è¿‘ã„ã‹ã‚‚ã§ã™ã€‚
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã™ã‚‹ã«ã¯`<Chats />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ Client Component ã«ã—ã¦ãªã‚“ã‚„ã‹ã‚“ã‚„ã™ã‚Œã°ã„ã‘ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã®ã‚¢ãƒ—ãƒªä½œæˆã‚’é€šã—ã¦ã€APP Router ã¯ã¾ã ã¾ã  production ã§ä½¿ã†ã«ã¯æ—©ã„ã‹ãªã¨ã‚‚æ€ã„ã¾ã—ãŸã€‚
ä¾‹ãˆã°ã€`next/link`ã‚’ä½¿ã£ã¦ãƒšãƒ¼ã‚¸é·ç§»ã™ã‚‹å ´åˆã«å¿…ãš soft navigation ã«ãªã£ã¦ã—ã¾ã£ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œãšã€æœ€æ–°ã§ãªã„ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†ã“ã¨ã§ã™ã€‚
`next/link`ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã§è­°è«–ã•ã‚Œã¦ã„ã¦ã€å°†æ¥çš„ã«`<Link />`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¦å¿…ãš revalidate ã™ã‚‹ãªã©ä½•ã‚‰ã‹ã®å¯¾å¿œãŒã•ã‚Œã‚Œã°ã„ã„ãªã¨æ€ã„ã¾ã™ã€‚
https://github.com/vercel/next.js/issues/42991

æœ€å¾Œã«ã€ã“ã®è¨˜äº‹ã‚’é€šã—ã¦ã€ã€Œã“ã“é–“é•ã£ã¦ã‚‹ã‚ˆï¼ã€ã‚„ã€Œã‚‚ã£ã¨ã“ã†ã—ãŸã»ã†ãŒã„ã„ã€ã¿ãŸã„ãªã“ã¨ãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã‚‹ã¨å¹¸ã„ã§ã™ï¼
