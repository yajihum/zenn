---
title: "チャットアプリ作成を通して学ぶApp Router/Server Actions"
emoji: "🔖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Next.js, App Router, Clerk, Prisma, PlanetScale]
published: false
---

## はじめに

App Router が安定版になったのでいよいよちゃんと学ばなければいけなくなりました。
また、Server Actions も実験的な機能ですが、使えるようになったため今回は、チャットアプリ作成を通して App Router と Server Actions を学んでいきます。

認証として[Clerk](https://clerk.com/)、ORM に[Prisma](https://www.prisma.io/)、DB に[PlanetScale](https://planetscale.com/)を使用します。

以下がデモのリポジトリです！

## セットアップ

セットアップを行っていきます。

1. いつも通りコマンドで`npx create-next-app@latest`を実行してプロジェクトを作成します。  
   オプションで`App Router`を選択するようにしてください。
2. `yarn dev`でローカルホストを立ち上げます。
3. ルート直下の`layout.tsx`を以下のように変更します。

```tsx:layout.tsx
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body className={inter.className}>
        <main className="mx-auto flex min-h-screen max-w-5xl flex-col place-content-center justify-between md:p-12">
          {children}
        </main>
      </body>
    </html>
  );
}
```

4. ルート直下の`page.tsx`を以下のように変更します。

```tsx:page.tsx
export default async function Home() {

  return (
    <div className="m-4">
      <p>こんにちは</p>
    </div>
  );
}
```

5. `global.css`の中身を一旦消して白背景に統一します。  
   Tailwind CSS の設定だけにします。

```css:global.css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

6. 以下のような表示になっていればひとまず OK です！

![こんにちはの表示](https://storage.googleapis.com/zenn-user-upload/637fa77d760a-20230601.png)

## Clerk を使った認証機能の実装

最近話題になっていた[Clerk](https://clerk.com/)を使って認証機能の実装をしていきます。

Clerk を簡単に説明しておくと、NextAuth.js のようなライブラリではなく、サービスとして使う形であり、ユーザー管理は GUI 操作を用いて Clerk のダッシュボードで行います。これにより、DB で User を管理する必要が無くなったり、より直感的で分かりやすく認証機能を実装を行うことができます。
ただ、サービスなので Free プラン以外にも Hobby（$25/月）/Business（$99/月）プランがあります。

https://clerk.com/pricing

今回は Free プランでやっていきます！

### Clerk のセットアップ

1. 以下 URL からサインインします。
   https://dashboard.clerk.com/
2. アプリの作成
   ダッシューボードに行ったら`Add application`でアプリを新規作成します。Application name に好きなプロジェクト名を入力し、Sign in する方法として今回は Google と GitHub を選択した状態で Create APPLICATION ボタンを押します。
3. アプリの作成が完了したら Quickstarts のところで Next.js を選択し、表示されている KEY をコピーします。
   そして、プロジェクト直下に`.env.local`ファイルを作り、先ほどコピーした KEY たちを貼り付けます。このファイルは必ず.gitignore に追加して（Next.js の場合はデフォルトで追加されているので OK）public に後悔しないように気をつけてください。
4. アプリの準備はできたので、次に実際にコード側で Clerk を使えるようにしていきます。  
   以下コマンドで clerk のライブラリをインストールします。

```:cmd
npm install @clerk/clerk-js
```

ひとまずはこれでセットアップ完了です！

### ClerkProvoder の作成

Provider を RootLayout に作成し、Context の共有を行います。この Provider を作成することで、どのページからでもセッションやユーザーの取得などを行うことができるようになります。
ここで、RootLayout とは、すべてのページの枠組みを作ることができる Layout ページで、例えば`<html>`や`<body>`、ヘッダーなど全てのページに共通する部分のレイアウトを書いておくことができます。

そして、同時に Clerk の日本語化対応もしていきます。

```diff tsx:layout.tsx
+ import { jaJP } from "@clerk/localizations";
+ import { ClerkProvider } from "@clerk/nextjs";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
+    <ClerkProvider localization={jaJP}>
      <html lang="ja">
        <body className={inter.className}>
          <main className="mx-auto flex min-h-screen max-w-5xl flex-col place-content-center justify-between md:p-12">
            {children}
          </main>
        </body>
      </html>
+    </ClerkProvider>
  );
}
```

`ClerkProvider`の部分に `localization` のプロパティで`jaJP`を渡して日本語化対応を行っています。

### Sign in ページの作成

サインインページを作っていきます。
ログイン画面の UI は Clerk の方で既に用意されたものを使うことで簡単に構築できます。
app 直下に`sign-in`フォルダーを、その配下に`[[...sign-in]]`フォルダーを作成します。

この`[[...sign-in]]`というフォルダー名の書き方は`Optional Catch-all Segments`というもので`/sign-in/xxxx`や`/sign-in/yyyy/zzzz`だけでなく`/sign-in`にもマッチして、ページをキャッチしてくれるものです。
https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes#optional-catch-all-segments

`[[...sign-in]]`フォルダは以下に`page.tsx`ファイルを作成します。
ファイルの中身を以下のようにします。

```tsx:page.tsx
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return (
    <div className="flex flex-col items-center">
      <SignIn redirectUrl={"/"} />
    </div>
  );
}
```

`<SignIn />`が Clerk で既に用意されているコンポーネントです。`redirectUrl`プロパティを記述することで今回の場合はホームページにリダイレクトするようにしています。

ここで試しに`/sign-in`にアクセスしてみましょう。以下のような画面が出たら OK です！
![Clerkのサインイン画面](https://storage.googleapis.com/zenn-user-upload/e17ce7fbd69f-20230603.png)

試しにログインしてみてください。ログインに成功したらホームページに飛ぶはずです。

他のライブラリとかだと、ログイン方法として Gogle や GitHub などの外部プロバイダと連携するにはプロバイダ先に行って別の設定が必要になったりする時がありますが、Clerk の場合は特に何もせずに利用可能なので楽でいいですね.

サインイン画面の時に出すアプリのロゴやカラーなどはダッシュボードの`Customization`から変更可能です。また細かいデザインは Tailwind CSS などを使って`appearance`プロパティから調整可能なようです！
https://clerk.com/docs/nextjs/appearance-prop

### ヘッダーの作成

今の状態だと画面が寂しいのでヘッダーを作っていきます。
app 直下に`_components`フォルダーを作成します。この`_`アンダーバーはルーティングの対象外にしたいファイルに対して書く時に使います。アンダーバーがあるフォルダは以下全てがルーティング対象外となります。
https://nextjs.org/docs/app/building-your-application/routing/colocation#private-folders

`_components`フォルダーの配下に`layout`フォルダー、その配下に`Header.tsx`ファイルを作成します。
ファイルの中身は以下のようにします。

```tsx:_components/layout/Header.tsx
import { SignInButton, SignedIn, SignedOut, UserButton } from "@clerk/nextjs";
import Link from "next/link";

export default function Header() {
  return (
    <header className="border-b border-gray-200">
      <nav className="flex justify-between p-2">
        <div className="flex">
          <Link href={"/"} className="p-2 text-sm font-semibold md:text-2xl">
            🍊ChatLife
          </Link>
        </div>
        <div>
          <SignedIn>
            {/* Mount the UserButton component */}
            <UserButton
              afterSignOutUrl="/"
            />
          </SignedIn>
          <SignedOut>
            {/* Signed out users get sign in button */}
            <SignInButton>
              <button className="rounded bg-blue-500 p-3 text-white hover:bg-blue-400">
                サインイン
              </button>
            </SignInButton>
          </SignedOut>
        </div>
      </nav>
    </header>
  );
}
```

`<SignedIn />`コンポーネントと`<SignedOut />`コンポーネントがあります。
前者はログインした後表示されるもので、中に`<UserButtom />`コンポーネントでログインした人のアイコンが表示されるようになります。
後者はログインしていない時に表示されるもので、サインインというボタンを表示しています。

この Header コンポーネントを RootLayout に追加します。

```diff tsx:/app/layout.tsx
...
+ import Header from "./_components/layout/header/Header";
...

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ClerkProvider localization={jaJP}>
      <html lang="ja">
        <body className={inter.className}>
+         <Header />
          <main className="mx-auto flex min-h-screen max-w-5xl flex-col place-content-center justify-between md:p-12">
            {children}
          </main>
        </body>
      </html>
    </ClerkProvider>
  );
}
```

以下のような表示になっていれば OK です！
![ヘッダー作成後の状態](https://storage.googleapis.com/zenn-user-upload/8f68c389e362-20230603.png)

自分のアイコンが出ている左上の丸い部分が Header.tsx にある`<UserButton />`になります。これも`appearance`プロパティがあるのでデザインを変えることも可能です。

### アカウント削除ボタンの追加

プロフィールにサインアウトボタンはありますが、アカウント削除ボタンがない状態です。アカウント削除したいユーザーもいると思うので、アカウント削除ボタンを追加しようと思います。

Clerk ではアカウント削除は [backend API を通してのみ実行可能](https://clerk.com/docs/users/deleting-users)であるため、プロフィールの近くにボタンを追加し、ユーザーはそのボタンをクリックすることでアカウント削除ができるようにします。

プロフィールのアカウントの管理ボタンに飛ぶと、モーダルが表示されると思います。このモダールとして表示されているコンポーネントは`<UserProfile />`になります。
https://clerk.com/docs/users/user-profile

このプロフィールのアカウントページにボタンを追加できればいいのですが、調べた感じだとボタンの追加はできなさそうです。（それ用のプロパティやダッシュボードからの設定などもないので無理そうでした）

そのため、今モーダルと表示しているアカウントページを`/account`にアクセスすることで見れるようにして、そこにアカウント削除ボタンを追加することにします。

### 認証された人限定ページの作成

次に、認証された（ログインした）人のみが見れるコンテンツがある場合などは`middleware`を使って制限をかけられるようにします。
src 直下に`middleware.ts`ファイルを作成し、中身を以下のようにします。

```ts:middleware.ts
import { authMiddleware } from "@clerk/nextjs";

export default authMiddleware({
  // publicRoutesで、認証されていない人でも見れるページを指定します
  // 今回の場合はホームページだけログインしてなくても見れるようにしています
  publicRoutes: ["/"],
});

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

より複雑な設定にしたい場合は下記を参考にして設定できると思います！
https://clerk.com/docs/nextjs/middleware

###
