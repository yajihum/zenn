---
title: "ChatGPT-APIã¨Next.jsã§ãŠæ‰‹è»½ãƒãƒ£ãƒƒãƒˆä½œæˆ"
emoji: "ğŸ™‰"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ChatGPT", "Next.js", "Typescript"]
published: true
---

# Next.js ã¨ ChatGPT-API ã§ä½œã‚‹é¢ç™½ã„ãƒãƒ£ãƒƒãƒˆä½“é¨“

ã“ã‚“ã«ã¡ã¯ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®çš†ã•ã‚“ï¼ä»Šå›ã¯ã€Next.js ã‚’ä½¿ã£ã¦ ChatGPT API ã‚’çµ„ã¿è¾¼ã‚“ã ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚ï¼ˆGPT ã‹ã‚‰å–ã£ã¦ããŸæŒ¨æ‹¶ï¼‰
1 æ—¥ã‚ã‚Œã°ãã‚Œã£ã½ã„è‰¯ã„æ„Ÿã˜ã®ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªãŒå‡ºæ¥ã¦ã—ã¾ã†ã®ã§æ°—è»½ã«è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼

å®Ÿéš›ã®ãƒ‡ãƒ¢ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ â†“
![ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¢](https://storage.googleapis.com/zenn-user-upload/c4d140a9c667-20230319.gif)

## æº–å‚™

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹å‰ã«ã€ä»¥ä¸‹ã®ãƒ„ãƒ¼ãƒ«ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™:

- Node.js
- Next.js
- TailwindCSS
- Chakra UI
- Framer Motion
- OpenAI node.js library

## æ‰‹é †

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯ã€`Next.js`ã¨`TailwindCSS`ã‚’ä½¿ã£ãŸæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§`Next.js`ã¨`tailwindCSS`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚
ã¡ãªã¿ã«ä»Šå›ã¯æ–°ã—ãå°å…¥ã•ã‚ŒãŸ app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```bash:bash
npx create-next-app@latest chat-app
cd chat-app
npm install tailwindcss@latest postcss@latest autoprefixer@latest
```

æ¬¡ã«ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ä»Šå›ã¯`Chakra UI`ã¨`Framer Motion`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`Chakra UI`ã¯`React`ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ç°¡å˜ã«ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã§ãã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚`Framer Motion`ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«è¿½åŠ ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash:bash
npm install @chakra-ui/react @emotion/react @emotion/styled framer-motion
```

TailwindCSS ã®ç´°ã‹ã„è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
ã¾ãšã€`tailwind.config.js`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff js:tailwind.config.js
module.exports = {
  content: [
+    "./app/**/*.{js,ts,jsx,tsx}",
+    "./pages/**/*.{js,ts,jsx,tsx}",
+    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

`globals.css`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff css:globals.css
+ @tailwind base;
+ @tailwind components;
+ @tailwind utilities;
```

æœ€å¾Œã« OpenAI ãŒä½œæˆã—ãŸ Node.js ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm install openai
```

### 2. ChatGPT API ã¨ã®ã‚„ã‚Šå–ã‚Š

å¤§æœ¬å‘½ã® ChatGPT API ã‚’ä½¿ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã¨é€ä¿¡ã®å‡¦ç†ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
ã¾ãšã€app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨åŒéšå±¤ã«`pages/api/messages/index.ts`ã‚’ä½œæˆã—ã€ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts:index.ts
import { NextApiRequest, NextApiResponse } from "next";
import { Configuration, OpenAIApi } from "openai";

// ç™ºè¡Œã—ãŸAPI Keyã‚’ä½¿ã£ã¦è¨­å®šã‚’å®šç¾©
const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
});
const openai = new OpenAIApi(configuration);

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  if (!configuration.apiKey) {
    res.status(500).json({
      error: {
        message:
          "OpenAI API key not configured, please follow instructions in README.md",
      },
    });
    return;
  }

  // GPTã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
  const message = req.body.message;

  try {
    // è¨­å®šã‚’è«¸ã€…ã®ã›ã¦APIã¨ã‚„ã‚Šå–ã‚Š
    const completion = await openai.createChatCompletion({
      model: "gpt-3.5-turbo",
      messages: message,
      temperature: 0.9,
      max_tokens: 100,
    });
    // GPTã®è¿”ç­”ã‚’å–å¾—
    res.status(200).json({ result: completion.data.choices[0].message });
  } catch (error: any) {
    // Consider adjusting the error handling logic for your use case
    if (error.response) {
      console.error(error.response.status, error.response.data);
      res.status(error.response.status).json(error.response.data);
    } else {
      console.error(`Error with OpenAI API request: ${error.message}`);
      res.status(500).json({
        error: {
          message: "An error occurred during your request.",
        },
      });
    }
  }
}
```

:::details ChatGPT API ã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹ã¨ãã«å¿…è¦ãªè¨­å®šã®è©³ç´°

```ts
const { Configuration, OpenAIApi } = require("openai");

const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY, // .env.localã§å®šç¾©ã™ã‚‹
});
const openai = new OpenAIApi(configuration);

const completion = await openai.createChatCompletion({
  model: "gpt-3.5-turbo", // ä½¿ã†ãƒ¢ãƒ‡ãƒ«
  messages: messages, // ä»Šã¾ã§ã®å±¥æ­´ã‚‚å«ã‚ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é›†
  temperature: 0.9, // ChatGPT ã®ç™ºè¨€ã®å¤šæ§˜ã•ãƒ»ãƒ©ãƒ³ãƒ€ãƒ åº¦åˆã„
  max_tokens: 200, // GPTã‹ã‚‰è¿”ã£ã¦ãã‚‹æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®åˆ¶é™ å°‘ãªã„ã»ã©è²»ç”¨ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹
});
console.log(completion.data.choices[0].message);
```

:::

:::details ChatGPT API ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°
ä»Šå›ã¯`message`ã«ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã¾ã™

```json
{
  "id": "chatcmpl-123",
  "object": "chat.completion",
  "created": 1677652288,
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "\n\nHello there, how may I assist you today?"
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 9,
    "completion_tokens": 12,
    "total_tokens": 21
  }
}
```

`role`ã¯`user`ãƒ»`assistant`ãƒ»`system`ã® 3 ç¨®é¡ãŒã‚ã‚Šã€API ã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã©ã‚“ãªäººã‹ã‚‰ã®ã‚‚ã®ã§ã‚ã£ãŸã‚Šã€ã©ã‚“ãªå½¹å‰²ã‚’æŒã¤ã‹ã‚’ç¤ºã™ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚ãã‚Œãã‚Œã®ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã§ã™ã€‚

- userï¼šGPT ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹äººã€ã¤ã¾ã‚Šç§ãŸã¡ã®ã“ã¨
- assistantï¼šGPT ã®ã“ã¨ã€‚GPT ã‹ã‚‰è¿”ã£ã¦ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ã“ã® role ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹
- systemï¼šGPT ã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã‚ˆã†ãªã‚‚ã®ã€‚ã€Œï½ã®ã‚ˆã†ã«æŒ¯èˆã£ã¦ãã ã•ã„ã€ã®ã‚ˆã†ãªæŒ‡ç¤ºã‚’ä¸ãˆã‚‹ role
  :::

æœ€å¾Œã«ã€ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
ã¾ãšã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€ä¸­èº«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã° OK ã§ã™ã€‚

```local:.env.local
OPENAI_API_KEY=ã‚ãªãŸã®APIKey;
```

APIKey ã¯[ã“ã“](https://platform.openai.com/account/api-keys)ã‹ã‚‰ä½œã‚Œã¾ã™ã€‚
ã“ã‚Œã§ API ã¨ã®ã‚„ã‚Šå–ã‚Šå‡¦ç†ã®è¿½åŠ ã¯å®Œäº†ã§ã™ï¼

### 2. ãƒšãƒ¼ã‚¸ã®ä½œæˆ

æ¬¡ã«ã€app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã« `page.tsx` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€Home ãƒšãƒ¼ã‚¸ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

Home ãƒšãƒ¼ã‚¸ã§ã¯ã€ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

- `Chat` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã£ã¦ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
- `InputForm` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã£ã¦å…¥åŠ›ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤º
- ãƒãƒ£ãƒƒãƒˆã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«`useState`ã‚’ä½¿ç”¨
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€`isSubmitting` ã¨ã„ã†çŠ¶æ…‹ã‚’ä½œæˆ
- `handleSubmit`é–¢æ•°ã‚’å®šç¾©ã—ã€`InputForm`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã™ã€‚ã“ã®é–¢æ•°ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€ä¿¡ã—ã€è¿”ç­”ã‚’å—ã‘å–ã£ã¦ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º

```tsx:page.tsx
"use client";

const Home: NextPage = () => {
  return (
    <div className="w-full max-w-2xl bg-white md:rounded-lg md:shadow-md p-4 md:p-10 my-10">
        // ã“ã®ä¸­ã«å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
    </div>
  );
};

export default Home;
```

app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ ServerCOmponents ã¨ãªã‚‹ãŸã‚ useState ã‚„ useEffect ãªã© ClientSide ã®æ©Ÿèƒ½ã‚’ä½¿ã„ãŸã„ã¨ãã¯`"use client";`ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šå›ã¯ã“ã® 1 ãƒšãƒ¼ã‚¸ã ã‘ã§ ClientSideRendering ã ã‘å¿…è¦ãªã®ã§ã€app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ©Ÿèƒ½ã¯çµæœçš„ã«ä¸è¦ã§ã—ãŸã€‚

### 2-1. ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ

ã¾ãšã€Chat ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã€app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«`components/Chat.tsx`ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ã€è‡ªåˆ†ã¾ãŸã¯ GPT å´ã® 1 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ã¦ã€ãã‚Œã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ãŸã„ã®ã§ã€Props ã¨ã—ã¦`content`ã¨`role`ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx:Chat.tsx
import { Message } from "../types/custom";

const Chat = ({ role, content }: Message) => {
  return <></>;
};

export default Chat;
```

Message å‹ã¯åºƒãä½¿ã†ãŸã‚ã€types é…ä¸‹ã«å®šç¾©ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«`types/custom.d.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:types/custom.d.ts
export type Message = {
  role: "system" | "assistant" | "user";
  content: string;
};
```

ãã—ã¦ã€`Chat.tsx`ã®ä¸­èº«ã‚’ ChakuraUI ã‚’ä½¿ã£ã¦ LINE ã®ã‚ˆã†ãª UI ã«ã™ã‚‹ã®ã¨åŒæ™‚ã«ã€Framer Motion ã§å®Ÿéš›ã® ChatGPT ã®ã‚ˆã†ã«æ–‡å­—ãŒå·¦ã‹ã‚‰å³ã«æ¬¡ã€…ã¨ç¾ã‚Œã‚‹ã‚ˆã†ãªè¦‹ãŸç›®ã«ã—ã¾ã™ã€‚

:::details æœ€çµ‚çš„ãª Chat.tsx ã®ä¸­èº«

- `motion.div`ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€é€æ˜åº¦ãŒ 0 ã‹ã‚‰ 1 ã«å¤‰ã‚ã‚Šã€Y è»¸æ–¹å‘ã«ç§»å‹•ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
- `Flex`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼šã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é…ç½®ã™ã‚‹ã€‚ã‚¢ãƒã‚¿ãƒ¼ã¯ã€å½¹å‰²ã«å¿œã˜ã¦ç•°ãªã‚‹ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
- ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å ´åˆã¯ chatMessage ã‚’ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯ content ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

```tsx:Chat.tsx
import { Avatar, Flex } from "@chakra-ui/react";
import { useEffect, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Message } from "../types/custom";

const Chat = ({ content, role }: Message) => {
  const chatStringIndex = useRef(0); // æ¬¡ã«è¡¨ç¤ºã™ã‚‹æ–‡å­—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒ
  const [chatMessage, setChatMessage] = useState(""); // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿æŒ

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¬¡ã®æ–‡å­—ã‚’è¿½åŠ ã—ã€chatStringIndexã‚’æ›´æ–°
  function appendChar() {
    setChatMessage((prev) => prev + content[chatStringIndex.current]);
    chatStringIndex.current++;
  }

  useEffect(() => {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’1æ–‡å­—ãšã¤è¡¨ç¤ºã™ã‚‹ã€‚ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã§ä½¿ç”¨
    if (chatStringIndex.current < content.length - 1) {
      const appendCharInterval = setInterval(appendChar, 70);
      return () => clearInterval(appendCharInterval);
    }
  }, [chatMessage, chatStringIndex.current]);

  return (
    <motion.div
      style={{
        alignSelf: role === "assistant" ? "flex-start" : "flex-end",
        width: "auto",
      }}
      initial={{
        opacity: 0,
        translateY: "100%",
      }}
      animate={{ opacity: 1, translateY: 0, transition: { duration: 0.3 } }}
      exit={{ opacity: 0, translateY: 0 }}
    >
      <Flex
        gap="5px"
        w="full"
        flexDir={role === "assistant" ? "row" : "row-reverse"}
        mt="10"
      >
        <Avatar
          name={role === "user" ? "Me" : "GPT"}
          w="40px"
          h="40px"
          src={
            role === "assistant"
              ? "https://emoji-img.s3.ap-northeast-1.amazonaws.com/svg/1f609.svg"
              : "https://emoji-img.s3.ap-northeast-1.amazonaws.com/svg/1f47c.svg"
          }
        />
        <Flex
          borderWidth={1}
          borderColor="blue.400"
          bg="main-bg"
          p="0.5rem 1rem"
          w="auto"
          mt="16"
          rounded={
            role === "assistant" ? "0 20px 20px 20px" : "20px 0 20px 20px"
          }
          fontSize={{ base: "8px", md: "18px" }}
          flexDir="column"
        >
          {role === "assistant" && (
            <Flex
              alignSelf="flex-end"
              fontStyle="italic"
              opacity={0.4}
              fontSize="8px"
              as="small"
              fontWeight={500}
            >
              GPT
            </Flex>
          )}
          {role === "user" && (
            <Flex
              alignSelf="flex-start"
              fontStyle="italic"
              opacity={0.4}
              fontSize="8px"
              as="small"
              fontWeight={500}
            >
              ã‚ãªãŸ
            </Flex>
          )}
          {role === "assistant" ? chatMessage || "" : content || ""}
        </Flex>
      </Flex>
    </motion.div>
  );
};

export default Chat;
```

:::

### 2-2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ä½œæˆ

`components/InputForm.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã™ã‚‹ãŸã‚ã® InputForm ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ã€å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ onSubmit é–¢æ•°ã«æ¸¡ã—ã€é€ä¿¡å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

:::details InputForm.tsx ã®ä¸­èº«

```tsx:InputForm.tsx
import React, { useRef } from "react";
import { Message } from "../types/custom";

type InputFormProps = {
  onSubmit: (message: Message) => Promise<void>; // onSUbmité–¢æ•°ã¯è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æä¾›ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã¨å‘¼ã³å‡ºã•ã‚Œã‚‹
};

const InputForm = ({ onSubmit }: InputFormProps) => {
  // inputè¦ç´ ã¸ã®å‚ç…§ã‚’ä½œæˆ
  const inputRef = useRef<HTMLInputElement>(null);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    // inputè¦ç´ ã‹ã‚‰ç›´æ¥å€¤ã‚’å–å¾—
    const inputValue = inputRef.current?.value;

    if (inputValue) {
      // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰æä¾›ã•ã‚ŒãŸonSubmité–¢æ•°ã‚’ä»‹ã—ã¦é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
      onSubmit({
        role: "user",
        content: inputValue,
      });
      inputRef.current.value = "";
    }
  };

  return (
    <form
      onSubmit={handleSubmit}
      className="flex items-center p-4 border-t border-gray-200"
    >
      <input
        type="text"
        ref={inputRef}
        className="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-300"
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
      />
      <button
        type="submit"
        className="ml-4 px-4 py-2 bg-blue-500 text-white rounded-lg focus:outline-none focus:ring focus:border-blue-300"
      >
        é€ä¿¡
      </button>
    </form>
  );
};

export default InputForm;
```

:::

### 2-3. Home ãƒšãƒ¼ã‚¸ã®å®Œæˆ

ã“ã‚Œã§`app/page.tsx`ã« Chat ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ InputForm ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

:::details page.tsx ã®ä¸­èº«

```tsx:page.tsx
"use client";

import { Flex } from "@chakra-ui/react";
import type { NextPage } from "next";
import { useState } from "react";
import { AnimatePresence } from "framer-motion";
import Chat from "./components/Chat";
import InputForm from "./components/InputForm";
import { Message } from "./types/custom";
import ThreeDotsLoader from "./components/ThreeDotsLoader";
import { siteTitle, system_prompt } from "./constants/constants";

const Home: NextPage = () => {

  // chats:ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆã‚’ä¿æŒã€‚åˆæœŸå€¤ã¨ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆsystem_promptï¼‰ã‚’å…¥ã‚Œã¦ãŠã
  const [chats, setChats] = useState<Message[]>([
    {
      role: "system",
      content: system_prompt,
    },
  ]);
  // isSubmitting: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°ã€‚GPTã®è¿”ç­”å¾…ã¡ã®é–“ã€Œãƒ»ãƒ»ãƒ»ã€ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (message: Message) => {
    try {
      setIsSubmitting(true);
      setChats((prev) => [...prev, message]);

      // ChatGPT APIã¨é€šä¿¡
      const response = await fetch("/api/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: [...chats, message].map((d) => ({
            role: d.role,
            content: d.content,
          })),
        }),
      });

      const data = await response.json();
      if (response.status !== 200) {
        throw (
          data.error ||
          new Error(`Request failed with status ${response.status}`)
        );
      }
      setChats((prev) => [...prev, data.result as Message]);
    } catch (error) {
      console.log(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="w-full max-w-2xl bg-white md:rounded-lg md:shadow-md p-4 md:p-10 my-10">
      <div className="mb-10">
        <AnimatePresence>
          {chats.slice(1, chats.length).map((chat, index) => {
            return <Chat role={chat.role} content={chat.content} key={index} />;
          })}
        </AnimatePresence>
      </div>
      <InputForm onSubmit={handleSubmit} />
    </div>
  );
};

export default Home;
```

`chats.slice()`ã®éƒ¨åˆ†ã¯`chats`ã§ä¿æŒã—ã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŸã¡ã® 1 ç•ªæœ€åˆã«`system`ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€ãŸã‚ã€ãã‚Œã‚’é™¤ã„ãŸã‚‚ã®ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::

:::details GPT API ã‹ã‚‰ã®è¿”ç­”å¾…ã¡æ™‚ã«è¡¨ç¤ºã™ã‚‹ 3 ç‚¹ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx:components/ThreeDotsLoader.tsx
const ThreeDotsLoader = () => {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      xmlnsXlink="http://www.w3.org/1999/xlink"
      style={{
        margin: "auto",
        background: "none",
        display: "block",
        shapeRendering: "auto",
      }}
      width="30px"
      height="30px"
      viewBox="0 0 100 100"
      preserveAspectRatio="xMidYMid"
    >
      <circle cx="84" cy="50" r="10" fill="rgba(111, 116, 96, 1)">
        <animate
          attributeName="r"
          repeatCount="indefinite"
          dur="0.7352941176470588s"
          calcMode="spline"
          keyTimes="0;1"
          values="10;0"
          keySplines="0 0.5 0.5 1"
          begin="0s"
        ></animate>
        <animate
          attributeName="fill"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="discrete"
          keyTimes="0;0.25;0.5;0.75;1"
          values="rgba(255, 255, 255, 0.4);rgba(255, 255, 255, 0.9999);rgba(255, 255, 255, 0.8);"
          begin="0s"
        ></animate>
      </circle>
      <circle cx="16" cy="50" r="10" fill="rgba(173, 174, 169, 1)">
        <animate
          attributeName="r"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="0;0;10;10;10"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="0s"
        ></animate>
        <animate
          attributeName="cx"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="16;16;16;50;84"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="0s"
        ></animate>
      </circle>
      <circle cx="50" cy="50" r="10" fill="rgba(43, 46, 32, 1)">
        <animate
          attributeName="r"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="0;0;10;10;10"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="-0.7352941176470588s"
        ></animate>
        <animate
          attributeName="cx"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="16;16;16;50;84"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="-0.7352941176470588s"
        ></animate>
      </circle>
      <circle cx="84" cy="50" r="10" fill="rgba(64, 73, 30, 1)">
        <animate
          attributeName="r"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="0;0;10;10;10"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="-1.4705882352941175s"
        ></animate>
        <animate
          attributeName="cx"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="16;16;16;50;84"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="-1.4705882352941175s"
        ></animate>
      </circle>
      <circle cx="16" cy="50" r="10" fill="rgba(111, 111, 111, 1)">
        <animate
          attributeName="r"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="0;0;10;10;10"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="-2.205882352941176s"
        ></animate>
        <animate
          attributeName="cx"
          repeatCount="indefinite"
          dur="2.941176470588235s"
          calcMode="spline"
          keyTimes="0;0.25;0.5;0.75;1"
          values="16;16;16;50;84"
          keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1"
          begin="-2.205882352941176s"
        ></animate>
      </circle>
    </svg>
  );
};

export default ThreeDotsLoader;
```

:::

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚„ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½œæˆ

ä¸€èˆ¬çš„ãª app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ‰±ã„æ–¹ã¨åŒæ§˜ã« app ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã«`Layout.tsx`ã¨`Main.tsx`ã€`Header.tsx`ã‚’ä½œæˆã—ã¾ã™ã€‚

ã“ã“ã§ã¯è©³ã—ã„èª¬æ˜ã¯çœãã¾ã™ã€‚

```tsx:app/Layout.tsx
import "./globals.css";
import Header from "./Header";
import Main from "./Main";

export const metadata = {
  title: "ChatGPTã¨ãŠã—ã‚ƒã¹ã‚Š",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <head />
      <body className="min-h-screen bg-white md:bg-gray-100">
        <Header />
        <Main>{children}</Main>
      </body>
    </html>
  );
}
```

```tsx:Header.tsx
import { siteTitle } from "./constants/constants";

const Header = () => {
  return (
    <header className="text-center py-5 bg-white shadow-md sticky top-0 z-10">
      <h1 className="text-lg md:text-3xl font-semibold px-4 whitespace-pre-line">
        {siteTitle}
      </h1>
    </header>
  );
};

export default Header;
```

```tsx:Main.tsx
export default function Main({ children }: { children: React.ReactNode }) {
  return (
    <main className="min-h-screen flex flex-grow items-center justify-center">
      {children}
    </main>
  );
}
```

ã¡ãªã¿ã«åŸºæœ¬çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ã¯ ChatGPT ã«è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦ä½œã‚Šã¾ã—ãŸã€‚
TailwindCSS ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ãªã‚‰ä»Šã®å¤ã„æƒ…å ±ã—ã‹ãªã„ GPT ã§ã‚‚ä½œã£ã¦ã‚‚ã‚‰ãˆãã†ã§ã™ï¼

## å®Œæˆï¼

ã“ã‚Œã§ã€ãŠæ‰‹è»½ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã¯å‹•ãã‚ˆã†ã«ãªã£ãŸã‹ã¨æ€ã„ã¾ã™ã€‚
è©³ã—ã„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã‚’è¦‹ã¦ã„ãŸã ã‘ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚ï¼ˆç§ã®å¥½ããªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒ­ãƒªã‚¹ã‹ã‚‰åå‰ã‚’ã¨ã£ã¦ãã¦ã„ã¾ã™ ğŸ˜³ï¼‰
https://github.com/yajium/rorisu-chat

## å‚è€ƒ

https://platform.openai.com/docs/api-reference/chat/create
https://awacreates.com/blog/build-a-chatbot-using-gpt-3s-api-and-nextjs
https://zenn.dev/azukiazusa/articles/next-js-app-dir-tutorial#%E8%A8%98%E4%BA%8B%E3%81%AE%E4%BD%9C%E6%88%90
